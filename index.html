<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercato Svincolati PRO</title>
    <!-- Tailwind CSS per lo stile -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icone Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #22c55e;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="text-center mb-8 md:mb-12">
            <img src="https://placehold.co/200x200/4B5563/FFFFFF?text=Logo+Lega" alt="Logo Lega" class="w-32 h-32 mx-auto mb-4 rounded-full object-cover bg-gray-700">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 tracking-tight">Mercato Svincolati</h1>
            <p class="text-gray-500 mt-2 text-lg">Stagione 2025/2026</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-2xl card-shadow sticky top-8">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i data-lucide="gavel" class="mr-2"></i>
                        Fai la tua Offerta
                    </h2>
                    <form id="offerForm">
                        <div class="mb-4">
                            <label for="squadra" class="block text-sm font-medium text-gray-700 mb-1">Seleziona squadra</label>
                            <select id="squadra" name="squadra" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                                <option value="" disabled selected>- Seleziona -</option>
                                <option value="Gonzi">Gonzi</option>
                                <option value="Chivas">Chivas</option>
                                <option value="Minturno">Minturno</option>
                                <option value="Califfo">Califfo</option>
                                <option value="BDS">BDS</option>
                                <option value="Diavolone">Diavolone</option>
                                <option value="RealSpillo">Real Spillo</option>
                                <option value="Pandamonio">Pandamonio</option>
                                <option value="SpaccioUno">SpaccioUno</option>
                                <option value="SantaMasterella">Santa Masterella</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="nome" class="block text-sm font-medium text-gray-700 mb-1">Giocatore (Cognome e Squadra)</label>
                            <input type="text" id="nome" name="nome" required placeholder="Es. Lautaro Martinez (Inter)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                        </div>
                        <div class="mb-4">
                            <label for="offerta" class="block text-sm font-medium text-gray-700 mb-1">Offerta (Fantamilioni)</label>
                            <input type="number" id="offerta" name="offerta" required min="1" placeholder="Es. 25" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password Squadra</label>
                            <input type="password" id="password" name="password" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 transition-transform transform hover:scale-105">
                            Invia Offerta
                        </button>
                    </form>
                    <div id="formResult" class="mt-4 text-center"></div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-2xl card-shadow">
                    <h2 class="text-2xl font-bold mb-1">Aste in Corso</h2>
                    <p class="text-sm text-red-600 font-semibold mb-4">IL GIOCATORE È ASSEGNATO AL MIGLIOR OFFERENTE ALLO SCADERE DELLE 24H DALLA PRIMA OFFERTA</p>
                    <div id="auctionsContainer">
                        <div id="loader" class="flex justify-center items-center py-16">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const AUCTION_DURATION_MS = 24 * 60 * 60 * 1000;

        const offerForm = document.getElementById('offerForm');
        const formResult = document.getElementById('formResult');
        const auctionsContainer = document.getElementById('auctionsContainer');
        const loader = document.getElementById('loader');

        // *** CORREZIONE IMPORTANTE: Usiamo i percorsi corretti per Vercel ***
        const GET_AUCTIONS_URL = '/api/get-auctions';
        const POST_BID_URL = '/api/post-bid';

        async function fetchData() {
            try {
                const response = await fetch(GET_AUCTIONS_URL);
                if (!response.ok) {
                    throw new Error(`Errore di rete: ${response.statusText}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Errore nel recupero dati:", error);
                auctionsContainer.innerHTML = `<p class="text-red-500 text-center">Impossibile caricare le aste. Riprova più tardi.</p>`;
                return [];
            }
        }

        function processAuctions(records) {
            const auctions = {};
            if (!records) return auctions;

            records.forEach(record => {
                const fields = record.fields;
                if (!fields) return;

                const playerName = fields.nome?.trim().toLowerCase();
                if (!playerName) return;

                if (!auctions[playerName]) {
                    auctions[playerName] = {
                        displayName: fields.nome.trim(),
                        bids: [],
                        highestBid: -1,
                        leadingTeam: null,
                        lastBidTimestamp: null,
                        firstBidTimestamp: null
                    };
                }
                
                const offerta = parseInt(fields.offerta, 10);
                const currentBid = {
                    team: fields.squadra,
                    offer: offerta,
                    timestamp: fields.data 
                };
                auctions[playerName].bids.push(currentBid);
            });

            for (const playerName in auctions) {
                const auction = auctions[playerName];
                auction.bids.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                auction.firstBidTimestamp = auction.bids[0].timestamp;
                auction.lastBidTimestamp = auction.bids[auction.bids.length - 1].timestamp;
                
                let highestBid = -1;
                let leadingTeam = null;
                auction.bids.forEach(bid => {
                    if (bid.offer > highestBid) {
                        highestBid = bid.offer;
                        leadingTeam = bid.team;
                    }
                });
                auction.highestBid = highestBid;
                auction.leadingTeam = leadingTeam;
            }
            return auctions;
        }

        function renderAuctions(auctions, openDetails = new Set()) {
            loader.style.display = 'none';
            auctionsContainer.innerHTML = '';
            
            const sortedAuctionKeys = Object.keys(auctions).sort((a, b) => {
                 return new Date(auctions[b].lastBidTimestamp) - new Date(auctions[a].lastBidTimestamp);
            });

            if (sortedAuctionKeys.length === 0) {
                auctionsContainer.innerHTML = `<p class="text-gray-500 text-center py-8">Nessuna asta in corso. Fai la prima offerta!</p>`;
                return;
            }

            sortedAuctionKeys.forEach(playerName => {
                const auction = auctions[playerName];
                const endDate = new Date(new Date(auction.firstBidTimestamp).getTime() + AUCTION_DURATION_MS);
                const timeLeft = endDate - new Date();
                const isExpired = timeLeft <= 0;
                const initialTimeDisplay = formatTimeLeft(timeLeft);
                const isDetailsOpen = openDetails.has(playerName);

                const card = document.createElement('div');
                card.className = `border rounded-xl p-4 mb-4 transition-all duration-300 ${isExpired ? 'bg-gray-100 opacity-70' : 'bg-white'}`;
                card.setAttribute('data-player', playerName);
                card.setAttribute('data-end-time', endDate.toISOString());

                const historyHtml = auction.bids.map(bid => `
                    <li class="flex justify-between items-center text-xs py-1 ${bid.offer === auction.highestBid ? 'font-bold' : ''}">
                        <span>${bid.team}</span>
                        <span class="text-gray-500">${formatDate(bid.timestamp, true)}</span>
                        <span>${bid.offer}</span>
                    </li>
                `).join('');

                card.innerHTML = `
                    <div class="grid grid-cols-3 gap-4 items-center">
                        <div class="col-span-3 md:col-span-1">
                            <h3 class="font-bold text-lg truncate">${auction.displayName}</h3>
                            <div class="flex items-center text-green-600 font-bold text-xl">
                                <i data-lucide="crown" class="mr-1 h-5 w-5"></i>
                                <span>${auction.highestBid}</span>
                                <span class="text-sm font-medium text-gray-500 ml-2">(${auction.leadingTeam})</span>
                            </div>
                        </div>
                        <div class="col-span-3 md:col-span-2 text-center">
                            ${isExpired 
                                ? `<div class="font-bold text-lg text-white bg-green-600 rounded-lg py-2">AGGIUDICATO!</div>` 
                                : `<div class="timer-container">
                                        <div class="text-sm text-gray-500">Tempo Rimanente</div>
                                        <div class="font-mono text-2xl font-bold tracking-tight" data-timer-id="${playerName}">${initialTimeDisplay}</div>
                                   </div>`
                            }
                        </div>
                    </div>
                    <div class="mt-4 border-t pt-2">
                        <details ${isDetailsOpen ? 'open' : ''}>
                            <summary class="text-sm font-medium cursor-pointer text-gray-600 hover:text-gray-900">Storico Rilanci (${auction.bids.length})</summary>
                            <ul class="mt-2 space-y-1 pr-2">${historyHtml}</ul>
                        </details>
                    </div>
                `;
                auctionsContainer.appendChild(card);
            });
            lucide.createIcons();
        }
        
        function formatTimeLeft(ms) {
            if (ms <= 0) return "00:00:00";
            const hours = Math.floor(ms / 3600000).toString().padStart(2, '0');
            const minutes = Math.floor((ms % 3600000) / 60000).toString().padStart(2, '0');
            const seconds = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
        
        function formatDate(dateTimeString, withSeconds = false) {
            if (!dateTimeString) return '';
            const date = new Date(dateTimeString);
            const options = { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' };
            if (withSeconds) options.second = '2-digit';
            return date.toLocaleString('it-IT', options);
        }

        function updateTimers() {
            document.querySelectorAll('[data-timer-id]').forEach(timerEl => {
                const player = timerEl.dataset.timerId;
                const card = document.querySelector(`[data-player="${player}"]`);
                if (!card) return;
                
                const endTime = new Date(card.dataset.endTime);
                const timeLeft = endTime - new Date();

                if (timeLeft <= 0) {
                    timerEl.textContent = "00:00:00";
                    if (!card.classList.contains('bg-gray-100')) {
                        main(); 
                    }
                } else {
                    timerEl.textContent = formatTimeLeft(timeLeft);
                }
            });
        }
        
        offerForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Invio...';

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(POST_BID_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: "Errore sconosciuto dal server." }));
                    throw new Error(errorData.error || `Errore durante l'invio.`);
                }
                
                showFormMessage('Offerta inviata con successo!', 'success');
                this.reset();
                await main();

            } catch (error) {
                showFormMessage(error.message, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Invia Offerta';
            }
        });
        
        function showFormMessage(message, type) {
            formResult.textContent = message;
            formResult.className = `mt-4 text-center text-sm font-medium ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
            setTimeout(() => { formResult.textContent = ''; }, 4000);
        }

        async function main() {
            const openDetails = new Set();
            document.querySelectorAll('#auctionsContainer details[open]').forEach(detail => {
                const card = detail.closest('[data-player]');
                if (card) openDetails.add(card.dataset.player);
            });

            const records = await fetchData();
            const auctions = processAuctions(records);
            renderAuctions(auctions, openDetails);
        }

        main();
        setInterval(main, 10000);
        setInterval(updateTimers, 1000);
    </script>
</body>
</html>

